#include <reg52.h>
#include <intrins.h>

#define CHAR_HEIGHT 32
#define CHAR_WIDTH CHAR_HEIGHT

#define LEFT_LCD 0
#define RIGHT_LCD 1

#define FOSC 18432000L
#define BAUD 9600

typedef unsigned char UCHAR;
typedef unsigned int UINT;

sbit CS1 = P1^7;
sbit CS2 = P1^6;
sbit RS = P3^5;
sbit RW = P3^4;
sbit E = P3^3;

/*Declare SFR associated with the ADC */
sfr ADC_CONTR = 0xBC; //ADC control register
sfr ADC_RES = 0xBD; //ADC high 8-bit result register
sfr ADC_LOW2 = 0xBE; //ADC low 2-bit result register
sfr P1ASF = 0x9D; //P1 secondary function control register
/*Define ADC operation const for ADC_CONTR*/
#define ADC_POWER 0x80 //ADC power control bit
#define ADC_FLAG 0x10 //ADC complete flag
#define ADC_START 0x08 //ADC start control bit
#define ADC_SPEEDLL 0x00 //540 clocks
#define ADC_SPEEDL 0x20 //360 clocks
#define ADC_SPEEDH 0x40 //180 clocks
#define ADC_SPEEDHH 0x60 //90 clocks

UCHAR code digit_code[10][64] = {
	
	{0x00,0x00,0x00,0x00,0x00,0x80,0xC0,0xC0,0x40,0x40,0xC0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0xFE,0xFF,0x0F,0x01,0x00,0x00,0x00,0x01,0x07,0xFF,0xFE,0xF0,0x00,0x00,0x00,0x3F,0xFF,0xFF,0xC0,0x00,0x00,0x00,0x00,0x00,0x80,0xFF,0xFF,0x3F,0x00,0x00,0x00,0x00,0x01,0x03,0x07,0x0E,0x0C,0x08,0x08,0x0E,0x07,0x03,0x01,0x00,0x00},/*"0",0*/

	{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x08,0x08,0x0C,0x0F,0x0F,0x0F,0x0C,0x08,0x08,0x08,0x00,0x00},/*"1",1*/

	{0x00,0x00,0x00,0x00,0x80,0xC0,0x40,0x40,0x40,0x40,0xC0,0xC0,0x80,0x80,0x00,0x00,0x00,0x00,0x1E,0x1F,0x19,0x00,0x00,0x00,0x00,0x00,0x00,0xC1,0xFF,0xFF,0x3E,0x00,0x00,0x00,0x00,0x00,0x80,0xC0,0x70,0x38,0x1C,0x0E,0x07,0x03,0x01,0xC0,0xC0,0x00,0x00,0x00,0x0E,0x0F,0x0D,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0E,0x0F,0x03,0x00},/*"2",2*/

	{0x00,0x00,0x00,0x80,0x80,0xC0,0x40,0x40,0x40,0xC0,0xC0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0x0F,0x0F,0x00,0x00,0x00,0x00,0x80,0xC1,0xFF,0x7F,0x3E,0x00,0x00,0x00,0x00,0xC0,0xC0,0xC0,0x00,0x01,0x01,0x01,0x03,0x03,0x06,0xFE,0xFC,0xF0,0x00,0x00,0x00,0x03,0x07,0x07,0x0C,0x08,0x08,0x08,0x08,0x0C,0x06,0x07,0x03,0x00,0x00},/*"3",3*/

	{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xE0,0x70,0x1C,0x0F,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x30,0x3C,0x2E,0x27,0x21,0x20,0x20,0x20,0xFF,0xFF,0xFF,0x20,0x20,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x08,0x08,0x0F,0x0F,0x0F,0x08,0x08,0x08,0x00},/*"4",4*/

	{0x00,0x00,0x00,0x00,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0x00,0x00,0x00,0x00,0xFF,0xFF,0x80,0xC0,0x40,0x40,0x40,0xC0,0xC0,0x80,0x00,0x00,0x00,0x00,0x00,0xC0,0xC3,0xC3,0x01,0x00,0x00,0x00,0x00,0x00,0x01,0xFF,0xFF,0xFC,0x00,0x00,0x00,0x03,0x07,0x04,0x0C,0x08,0x08,0x08,0x08,0x0C,0x07,0x07,0x03,0x00,0x00},/*"5",5*/

	{0x00,0x00,0x00,0x00,0x00,0x80,0x80,0xC0,0x40,0x40,0x40,0xC0,0x80,0x80,0x00,0x00,0x00,0x00,0xE0,0xFC,0xFF,0x87,0xC1,0xC0,0x40,0x40,0xC0,0xC3,0x83,0x03,0x00,0x00,0x00,0x00,0x7F,0xFF,0xFF,0x83,0x00,0x00,0x00,0x00,0x00,0x01,0xFF,0xFF,0xFC,0x00,0x00,0x00,0x00,0x01,0x07,0x07,0x0E,0x0C,0x08,0x08,0x0C,0x0E,0x07,0x03,0x00,0x00},/*"6",6*/

	{0x00,0x00,0x00,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0x00,0x00,0x00,0x0E,0x0F,0x03,0x00,0x00,0x00,0x00,0xE0,0xF8,0x1E,0x07,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xFC,0xFF,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0x0F,0x0F,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"7",7*/

	{0x00,0x00,0x00,0x00,0x80,0xC0,0xC0,0x40,0x40,0x40,0xC0,0xC0,0x80,0x00,0x00,0x00,0x00,0x00,0x3E,0x7F,0xFF,0xF1,0xC0,0xC0,0x80,0x00,0x80,0xC1,0x7F,0x7F,0x1E,0x00,0x00,0xF0,0xFC,0xFE,0x0E,0x03,0x01,0x01,0x03,0x07,0x0F,0x1E,0xFE,0xFC,0xF0,0x00,0x00,0x01,0x03,0x07,0x06,0x0C,0x08,0x08,0x08,0x08,0x0C,0x06,0x07,0x03,0x01,0x00},/*"8",8*/

	{0x00,0x00,0x00,0x80,0x80,0xC0,0x40,0x40,0x40,0x40,0xC0,0x80,0x00,0x00,0x00,0x00,0x00,0xFC,0xFF,0xFF,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xFF,0xFE,0xF8,0x00,0x00,0x01,0x03,0x07,0x0F,0x0C,0x08,0x08,0x08,0x0C,0x06,0xE7,0xFF,0x7F,0x1F,0x00,0x00,0x00,0x07,0x07,0x0F,0x08,0x08,0x08,0x0C,0x0E,0x07,0x03,0x01,0x00,0x00,0x00},/*"9",9*/
		
};

UCHAR code alpha_g[] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xC0,0x60,0x20,0x20,0x20,0x60,0xE0,0xE0,0xE0,0x60,0x60,0x00,0x00,0x00,0xC7,0xFF,0xFF,0x30,0x20,0x20,0x20,0x30,0x3F,0x1F,0x0F,0x00,0x00,0x00,0x00,0x38,0x7D,0x7F,0xC7,0x83,0x83,0x83,0x83,0x83,0xC6,0x7E,0x7E,0x3C,0x00};/*"g",0*/
	
void lcm_pending()
{
	P2 = 0x00;
	RS = 0;
	RW = 1;
	E = 1;
	while(P2^7 == 1);
	E = 0;
}
	
void delay_lcm()
{
	UCHAR t = 32;
	while (t--)
		_nop_();
}

void delay(UCHAR n)
{
	UINT x;
	while (n--)
	{
		x = 5000;
		while (x--);
	}
}

void cmd_out(UCHAR cmd)
{
	P2 = 0xFF;
	lcm_pending();
	RS = 0;
	RW = 0;
	P2 = cmd;
	E = 1;
	delay_lcm();
	E = 0;
}

void switch_on()
{
	cmd_out(0x3F);
}

void switch_off()
{
	cmd_out(0x3E);
}

void set_init_line_ptr(UCHAR line)
{
	cmd_out(0xC0 | line);
}

void set_page_ptr(UCHAR page)
{
	cmd_out(0xB8 | page);
}

void set_column_ptr(UCHAR column)
{
	cmd_out(0x40 | column);
}

void write_data(UCHAR dt)
{
	P2 = 0xFF;
	lcm_pending();
	RS = 1;
	RW = 0;
	P2 = dt;
	E = 1;
	delay_lcm();
	E = 0;
	//CS1 = 0;
}

void reset_lcm()
{
	UCHAR i = 0, j = 0;
	CS1 = 1;
	CS2 = 1;
	set_init_line_ptr(0);
	for (i = 0; i < 8; i++)
	{
		set_page_ptr(i);
		set_column_ptr(0);
		for (j = 0; j < 64; j++)
			write_data(0x00);
	}
	CS1 = 0;
	CS2 = 0;
}

void dispaly_alnum(UCHAR xpage_offset, UCHAR y_offset, UCHAR* ptr)
{
	UCHAR i = 0, j = 0, yj;
	
	for (i = xpage_offset; i < xpage_offset + CHAR_HEIGHT / 8; i++)
	{
		set_column_ptr(y_offset);
		for (j = y_offset; j < y_offset + CHAR_WIDTH / 2; j++)
		{
			yj = j;
			if (yj < 64)
			{
				CS1 = 1;
				CS2 = 0;
			}
			else
			{
				CS1 = 0;
				CS2 = 1;
				yj -= 64;
			}
			set_page_ptr(i);
			set_column_ptr(yj);
			
			write_data(*(ptr));
			ptr++;
		}
	}
	
	CS1 = 0;
	CS2 = 0;
}

void display_weight(UCHAR w)
{
	dispaly_alnum(2, 32, digit_code[w / 100]);
	dispaly_alnum(2, 48, digit_code[w / 10 % 10]);
	dispaly_alnum(2, 64, digit_code[w % 10]);
	dispaly_alnum(2, 80, alpha_g);
}

void init_uart()
{
	SCON = 0x5a; //8 bit data ,no parity bit
	TMOD = 0x20; //T1 as 8-bit auto reload
	TH1 = TL1 = -(FOSC/12/32/BAUD); //Set Uart baudrate
	TR1 = 1;
}

void init_adc()
{
	P1ASF = 0x01; //Open 8 channels ADC function
	ADC_RES = 0; //Clear previous result
	ADC_CONTR = ADC_POWER | ADC_SPEEDLL;
	delay(2); //ADC power-on and delay
}

UCHAR get_ad_result(UCHAR channel)
{
	ADC_CONTR = ADC_POWER | ADC_SPEEDLL | channel | ADC_START;
	_nop_(); //Must wait before inquiry
	_nop_();
	_nop_();
	_nop_();
	while (!(ADC_CONTR & ADC_FLAG)); //Wait complete flag
	ADC_CONTR &= ~ADC_FLAG; //Close ADC
	return ADC_RES; //Return ADC result
}

void main()
{
	init_uart();
	init_adc();
	lcm_pending();
	switch_on();
	
	
	reset_lcm();
	
	display_weight(123);
	while (1)
	{
		UCHAR res = get_ad_result(0);
		// Adjust weight here
		res = res == 0 ? 0 : (res + 1) * 2;
		display_weight(res);
	}
}